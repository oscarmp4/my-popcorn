#!/usr/bin/env node

var cli 		= require('cli');
var options 	= cli.parse();
var fs 			= require('fs');
var exec 		= require('child_process').exec;
var cwd 		= process.cwd();
var jf 			= require('jsonfile');
var crypto 		= require('crypto');
var path 		= require('path');
var AppName 	= path.basename(cwd);
// var readline 	= require('readline');

// var rl = readline.createInterface({
//   input: process.stdin,
//   output: process.stdout
// });

cli.parse(null, ['init', 'routes']);


switch (cli.command) {
	case 'init':

		var current_date 	= (new Date()).valueOf().toString();
		var random			= Math.random().toString();
		var secret 			= crypto.createHash('sha1').update(current_date + random).digest('hex');


		cli.info ("Downloading a local version of neasy...");

		child = exec('npm install neasy --save', function () {
			
			var folders = [
				'controllers',
				'models',
				'public',
				'public/assets',
				'public/assets/dev',
				'public/assets/dev/css',
				'public/assets/dev/js',
				'public/assets/dev/js/vendor',
				'public/assets/dev/img',
				'routes',
				'views',
				'sass'
			];

			folders.forEach(function (folder) {
				var dir = cwd + '/' + folder;

				if (fs.mkdirSync(dir)) {
					console.info("Creating directory " + folder);
				}
			});


			var files = [
				'app.js', 
				'.foreverignore',
				'models/user.js',
				'controllers/user.js',
				'routes/user.js',
				'public/assets/dev/css/app.css',
				'public/assets/dev/js/vendor/require.js',
				'public/assets/dev/js/app.js',
				'views/index.twig',
				'sass/app.scss'
			];

			files.forEach(function (file) {
				cli.info('Copying file ' + file);
				var src 	= __dirname + '/install/' + file;
				var target 	= cwd + '/' + file;

				fs.createReadStream(src).pipe(fs.createWriteStream(target));
			});


			var config = {
				cookie: {
					secret: secret
				},
				server: {
					domain: 'localhost',
					port: 5000
				},
				database: {
					name: AppName
				}
			};

	
			jf.writeFile(cwd + '/neasy.json', config, function(err) {
				cli.ok('neasy.json file created!');

				cli.ok('Your new app '+ AppName +' is ready! Run: node app.js');
			});

		}).stderr.pipe(process.stderr);

	
	break;
}